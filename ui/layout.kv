#:kivy 2.3.0
#:import ChatScreenLogic ui.screens.chat.ChatScreenLogic
#:import NotepadLogic ui.screens.notepad.NotepadLogic
#:import ChatBubble ui.widgets.bubble.ChatBubble

<MainLayout>:
    orientation: 'vertical'
    md_bg_color: [0.05, 0.05, 0.05, 1]  # Głęboka czerń

    # --- HEADER ---
    MDBoxLayout:
        size_hint_y: None
        height: "50dp"
        padding: "10dp"
        md_bg_color: [0.08, 0.08, 0.08, 1]
        elevation: 2
        
        MDIcon:
            icon: "console-network"
            theme_text_color: "Custom"
            text_color: [0, 1, 0, 1] # Neon Green
            pos_hint: {"center_y": .5}
        
        MDLabel:
            text: " AGENT 007 // DEV CONSOLE"
            bold: True
            font_style: "H6"
            theme_text_color: "Custom"
            text_color: [0.8, 1, 0.8, 1]
            pos_hint: {"center_y": .5}

        MDIconButton:
            icon: "restart"
            tooltip_text: "New Session"
            on_release: app.start_new_chat()
            theme_text_color: "Custom"
            text_color: app.theme_cls.primary_color

    MDSeparator:
        height: "1dp"
        color: [0, 0.5, 0, 0.5]

    # --- SPLIT VIEW BODY ---
    MDBoxLayout:
        orientation: 'horizontal'
        
        # --- LEFT PANEL: NOTEPAD (35%) ---
        NotepadLogic:
            id: notepad_panel
            size_hint_x: 0.35
            
        # V-Separator
        MDSeparator:
            orientation: 'vertical'
            width: "1dp"
            color: [0, 0.5, 0, 0.3]

        # --- RIGHT PANEL: CHAT (65%) ---
        ChatScreenLogic:
            id: chat_screen
            size_hint_x: 0.65

# --- DEFINICJE WIDGETÓW ---

<NotepadLogic>:
    orientation: 'vertical'
    padding: "5dp"
    md_bg_color: [0.07, 0.07, 0.07, 1]
    
    MDBoxLayout:
        size_hint_y: None
        height: "40dp"
        padding: "5dp"
        MDLabel:
            text: "LOCAL SCRATCHPAD"
            font_style: "Caption"
            theme_text_color: "Custom"
            text_color: [0, 0.7, 0, 1]
        MDIconButton:
            icon: "content-save"
            icon_size: "18sp"
            on_release: root.save_to_file()

    MDTextField:
        id: notepad_field
        multiline: True
        mode: "rectangle"
        line_color_focus: [0, 1, 0, 1]
        text_color_normal: [0.9, 0.9, 0.9, 1]
        text_color_focus: [1, 1, 1, 1]
        font_name: "RobotoMono-Regular"
        hint_text: "Type code here..."

<ChatScreenLogic>:
    orientation: 'vertical'
    
    # 1. Chat Area
    MDScrollView:
        id: scroll_view
        md_bg_color: [0.1, 0.1, 0.1, 1]
        MDBoxLayout:
            id: chat_list
            orientation: 'vertical'
            adaptive_height: True
            padding: "20dp"
            spacing: "15dp"

    # 2. Status Bar (WOW Effect)
    MDCard:
        size_hint_y: None
        height: "32dp" if root.is_processing else "0dp"
        opacity: 1 if root.is_processing else 0
        md_bg_color: [0, 0.2, 0, 1]
        radius: [0,]
        padding: "10dp"
        
        MDLabel:
            text: root.status_message
            font_style: "Caption"
            theme_text_color: "Custom"
            text_color: [0, 1, 0, 1]
            valign: "center"
            
        MDLabel:
            text: "LATENCY: " + root.response_time
            halign: "right"
            font_style: "Caption"
            bold: True
            theme_text_color: "Custom"
            text_color: [0.5, 1, 0.5, 1]

    # 3. Input Area
    MDBoxLayout:
        size_hint_y: None
        height: "80dp"
        padding: "10dp"
        spacing: "10dp"
        md_bg_color: [0.08, 0.08, 0.08, 1]
        
        MDCard:
            md_bg_color: [0.15, 0.15, 0.15, 1]
            radius: [10,]
            padding: [5, 5, 5, 5]
            
            MDTextField:
                id: message_input
                hint_text: "Command Input (Ctrl+Enter to Send)..."
                mode: "fill"
                fill_color_normal: [0,0,0,0]
                active_line: False
                line_color_normal: [0,0,0,0]
                text_color_normal: [1, 1, 1, 1]
                font_size: "16sp"
                
        MDIconButton:
            icon: "send"
            theme_text_color: "Custom"
            text_color: [0, 1, 0, 1]
            md_bg_color: [0, 0.2, 0, 1]
            on_release: root.send_message()

<ChatBubble>:
    adaptive_height: True
    padding: [10, 10]
    
    MDCard:
        size_hint: None, None
        size: label.texture_size
        width: label.texture_size[0] + 30
        height: label.texture_size[1] + 20
        # Kolory bąbelków: User (Ciemny Zielony), Bot (Szary/Czarny)
        md_bg_color: [0, 0.3, 0, 1] if root.is_user else [0.2, 0.2, 0.2, 1]
        radius: [10, 10, 0, 10] if root.is_user else [10, 10, 10, 0]
        padding: "10dp"
        
        MDLabel:
            id: label
            text: root.text
            color: [1,1,1,1]
            size_hint: None, None
            size: self.texture_size
            text_size: 600, None
            markup: True